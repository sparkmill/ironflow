name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      sql: ${{ steps.filter.outputs.sql }}
      toml: ${{ steps.filter.outputs.toml }}
    steps:
      - uses: actions/checkout@v6

      - name: Check changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            # SQL migration changes only
            sql:
              - 'crates/ironflow/migrations/**/*.sql'
            # TOML file changes only
            toml:
              - '**/*.toml'

  sql-format:
    name: SQL Formatting
    needs: changes
    if: needs.changes.outputs.sql == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install pgFormatter
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends pgformatter

      - name: Check SQL formatting
        run: ./scripts/format-sql.sh --check

  toml-format:
    name: TOML Formatting
    needs: changes
    if: needs.changes.outputs.toml == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Cache taplo binary
        id: cache-taplo
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin/taplo
          key: ${{ runner.os }}-taplo-0.10.0

      - name: Install taplo
        if: steps.cache-taplo.outputs.cache-hit != 'true'
        run: cargo install taplo-cli --version 0.10.0 --locked

      - name: Check TOML formatting
        run: ./scripts/format-toml.sh --check

  rust:
    name: Rust
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "postgres://postgres:postgres@localhost:5432/ironflow"
      TEST_ADMIN_DATABASE_URL: "postgres://postgres:postgres@localhost:5432/postgres"
    steps:
      - uses: actions/checkout@v6

      - name: Spin up docker services
        run: ./scripts/spin_up_docker_services.sh
        shell: bash

      - name: Set up Rust
        # Automatically uses rust-toolchain.toml from the repository
        uses: actions-rust-lang/setup-rust-toolchain@v1.15

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: .
          cache-on-failure: true
          cache-all-crates: true

      - name: Install sqlx-cli
        run: ./scripts/sqlx_install.sh
        shell: bash

      - name: Run database migrations
        run: ./scripts/sqlx_migrate.sh
        shell: bash

      - name: Typecheck
        run: cargo check --workspace --all-targets --all-features

      - name: Format
        run: cargo fmt --all -- --check

      - name: Lint
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Security Audit
        run: |
          cargo install --locked cargo-deny
          ./scripts/security-check.sh

      - name: Test
        run: cargo test --workspace --all-features --all-targets
